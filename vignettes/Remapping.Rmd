---
title: "Remapping"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Remapping}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(dm)
library(dunlin)

```

## Introduction

Remapping in `dulin` consists in replacing predetermined values by another in particular variables for selected tables of a data set stored under the form of a `dm` object. 

This is performed in two steps: 

1. A mapping list is created which specifies the correspondance between the old and the new values

2. The remapping itself is performed with the `dunlin::remap()` function.

## The Mapping List Structure

The Mapping List is a list object with 4 hierarchic levels. 

1. The table name. Typically one of the values returned by `names(db)` where db is `dm` object. For instance, in the case of an `adam` data set, `adsl` or `adae` etc...

2. The variable name. The name of the column in a table of a `dm` object. For instance `ACTARM`.

3. The Key, the new value that will replace the old ones

4. The Values, a vector or values, that have to be replaced by their associated key.
 
The `All` keyword can be used instead of a table name to indicate that a particular variable should be changed in every
table where it appears.
 
The values can be a `string`, a `character` vector or `NA`. Values that are present in the original table and not listed
in the mapping are left unchanged, except that all altered columns are turned into `factor` class. If the original
variable is a `factor`, the non remapped levels are preserved even if the corresponding value does not appear.

The order in which the key appear determine the order of the levels in the output. Hence the function can be used to re
level variables. However, the level replacing missing values will automatically be placed last.
 
#### Example of Mapping List

```{r}

 my_map <- list(
   adsl = list(
     SEX = list(
       "Male" = c("M", "m"),
       "Female" = c("F", "f")
     )
   ),
   adae = list(
     DTHFL = list(
       "NO" = "N",
       "YES" = "Y",
      "New Level" = "new_level",
       "<Missing>" = NA
     ),
     SEX = list(
       "MALE" = c("M", "m"),
       "FEMALE" = c("F", "f")
     )
   ),
   All = list(
     ARM = list(
      "A: Treatment" = "A: Drug X",
      "B: Placebo" = "B: Placebo"
     )
   )
 )

```
 

## Re mapping
 
Once the re mapping list is defined, the remapping can be performed on a `dm` object.

#### Example

```{r}

adam <- dm::new_dm(tables = scda.2021::rcd_2021_03_22)

res <- remap(adam, my_map)
head(adam$adsl$SEX)
head(res$adsl$SEX)

# New levels are introduced and missing values can be replaced.
head(adam$adae$DTHFL)
head(res$adae$DTHFL)

# Using the `All` keyword changes several tables.
head(adam$adae$ARM)
head(res$adae$ARM)

head(adam$adsl$ARM)
head(res$adsl$ARM)


```
